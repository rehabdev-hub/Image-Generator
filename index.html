<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'primary-dark': '#4338ca',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for better aesthetic and handling aspect ratio */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .aspect-ratio-box {
            background-color: #e5e7eb;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .aspect-1-1 {
            aspect-ratio: 1 / 1;
        }
        .aspect-16-9 {
            aspect-ratio: 16 / 9;
        }
        .aspect-9-16 {
            aspect-ratio: 9 / 16;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-2xl shadow-2xl">
        <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center">
            Gemini Image Generator
        </h1>
        <p class="text-gray-500 mb-8 text-center">
            Describe the image you want, select an aspect ratio, and create!
        </p>

        <!-- Input Form -->
        <div class="space-y-6 mb-8">
            <div>
                <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Image Description (Prompt)</label>
                <textarea id="prompt" rows="4" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition duration-150 ease-in-out" placeholder="e.g., A cyberpunk cat sitting on a neon sign in a rainy futuristic city, photorealistic, cinematic lighting."></textarea>
            </div>

            <div>
                <label for="aspectRatio" class="block text-sm font-medium text-gray-700 mb-2">Aspect Ratio</label>
                <select id="aspectRatio" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-primary focus:border-primary transition duration-150 ease-in-out">
                    <option value="1:1">Square (1:1)</option>
                    <option value="16:9">Landscape (16:9)</option>
                    <option value="9:16">Portrait (9:16)</option>
                </select>
            </div>

            <button id="generateBtn" class="w-full flex justify-center items-center py-3 px-6 border border-transparent rounded-lg shadow-lg text-lg font-semibold text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-4 focus:ring-primary focus:ring-opacity-50 transition duration-300 ease-in-out" onclick="generateImage()">
                Generate Image
            </button>
        </div>

        <!-- Output Section -->
        <div class="mt-10 border-t pt-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 text-center">Result</h2>
            <div id="imageOutputContainer" class="min-h-[200px] flex justify-center items-center">
                <p id="initialMessage" class="text-gray-500 text-center p-4">Your generated image will appear here.</p>
                
                <!-- Placeholder for the aspect-ratio-box and image -->
                <div id="imagePlaceholder" class="w-full sm:w-3/4 max-w-lg hidden">
                    <div id="aspectBox" class="aspect-ratio-box">
                        <div id="loadingIndicator" class="hidden loading-spinner"></div>
                        <img id="generatedImage" class="w-full h-full object-cover hidden" src="" alt="Generated AI Image">
                    </div>
                    <!-- Error/Status Message Box -->
                    <div id="statusMessage" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>

                    <!-- NEW DOWNLOAD BUTTON -->
                    <button id="downloadBtn" class="mt-4 w-full flex justify-center items-center py-2 px-4 border border-transparent rounded-lg shadow-md text-sm font-semibold text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50 transition duration-300 ease-in-out hidden" onclick="downloadImage()">
                        Download Image
                    </button>
                </div>
            </div>
        </div>

    </div>

    <script type="text/javascript">
        // Global constants and setup
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`;
        const MAX_RETRIES = 5;

        // DOM Elements
        const promptInput = document.getElementById('prompt');
        const aspectRatioSelect = document.getElementById('aspectRatio');
        const generateBtn = document.getElementById('generateBtn');
        const initialMessage = document.getElementById('initialMessage');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const aspectBox = document.getElementById('aspectBox');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const generatedImage = document.getElementById('generatedImage');
        const statusMessage = document.getElementById('statusMessage');
        const downloadBtn = document.getElementById('downloadBtn'); // NEW: Download button

        /**
         * Generic function for displaying status/error messages.
         * @param {string} message The message to display.
         * @param {string} type 'success' or 'error' for styling.
         */
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (type === 'error') {
                statusMessage.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                statusMessage.classList.add('bg-green-100', 'text-green-700');
            }
        }

        /**
         * Sets the current state of the UI (loading, ready, error).
         * @param {'loading'|'ready'|'error'} state 
         * @param {string} message Optional status message.
         */
        function setUIState(state, message = '') {
            initialMessage.classList.add('hidden');
            imagePlaceholder.classList.remove('hidden');
            generatedImage.classList.add('hidden');
            loadingIndicator.classList.add('hidden');
            statusMessage.classList.add('hidden');
            downloadBtn.classList.add('hidden'); // Hide download button when not ready
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate Image';
            aspectBox.style.backgroundColor = '#e5e7eb'; // Default background

            if (state === 'loading') {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<div class="loading-spinner border-white border-t-2"></div><span class="ml-2">Generating...</span>';
                loadingIndicator.classList.remove('hidden');
                aspectBox.style.backgroundColor = '#f3f4f6'; // Light loading background
                generatedImage.src = '';
            } else if (state === 'error') {
                showStatus(message, 'error');
            } else if (state === 'ready') {
                if (message) {
                    showStatus(message, 'success');
                }
                generatedImage.classList.remove('hidden');
                aspectBox.style.backgroundColor = 'transparent';
                downloadBtn.classList.remove('hidden'); // Show download button
            }
        }

        /**
         * Adjusts the container class to match the selected aspect ratio.
         * @param {string} ratio '1:1', '16:9', or '9:16'
         */
        function updateAspectRatioClass(ratio) {
            aspectBox.classList.remove('aspect-1-1', 'aspect-16-9', 'aspect-9-16');
            if (ratio === '1:1') {
                aspectBox.classList.add('aspect-1-1');
            } else if (ratio === '16:9') {
                aspectBox.classList.add('aspect-16-9');
            } else if (ratio === '9:16') {
                aspectBox.classList.add('aspect-9-16');
            }
        }

        /**
         * Attaches the aspect ratio cue to the user's prompt.
         * @param {string} prompt The user's input prompt.
         * @param {string} ratio The selected aspect ratio.
         * @returns {string} The modified prompt.
         */
        function enhancePromptWithRatio(prompt, ratio) {
            let ratioCue = '';
            if (ratio === '1:1') {
                ratioCue = 'A high-detail square composition, ';
            } else if (ratio === '16:9') {
                ratioCue = 'An expansive 16:9 wide-screen cinematic view, ';
            } else if (ratio === '9:16') {
                ratioCue = 'A striking 9:16 vertical portrait composition, ';
            }
            // Add the cue to the beginning of the prompt
            return ratioCue + prompt.trim();
        }

        /**
         * Fetches data from the Gemini API with exponential backoff.
         */
        async function fetchWithBackoff(url, options, maxRetries = MAX_RETRIES) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    
                    if (response.status === 429) { // Too Many Requests (Rate Limit)
                        throw new Error("Rate limit exceeded, retrying...");
                    }

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error("API Error Response:", errorBody);
                        throw new Error(`API request failed: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (error.message.includes("API request failed") || i === maxRetries - 1) {
                         // Rethrow for UI to handle if it's a non-rate limit error or last retry failed
                        throw error;
                    }
                    console.warn(`Attempt ${i + 1} failed, retrying in ${delay / 1000}s... Error: ${error.message}`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                }
            }
        }

        /**
         * Initiates the download of the generated image.
         */
        function downloadImage() {
            const imageDataUrl = generatedImage.src;
            if (!imageDataUrl || generatedImage.classList.contains('hidden')) {
                showStatus('No image available to download.', 'error');
                return;
            }

            // Create a temporary anchor element
            const a = document.createElement('a');
            a.href = imageDataUrl;
            // Set the filename
            const filename = `gemini-image-${new Date().getTime()}.png`;
            a.download = filename; 

            // Append to body, trigger click, and remove
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        /**
         * Main function to handle image generation.
         */
        async function generateImage() {
            const userPrompt = promptInput.value.trim();
            const ratio = aspectRatioSelect.value;
            
            if (!userPrompt) {
                showStatus('Please enter a description for the image.', 'error');
                return;
            }

            // 1. Update UI and Aspect Ratio
            setUIState('loading');
            updateAspectRatioClass(ratio);

            const finalPrompt = enhancePromptWithRatio(userPrompt, ratio);

            const payload = { 
                instances: [{ prompt: finalPrompt }], 
                parameters: { 
                    "sampleCount": 1
                } 
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                // 2. Make API Call with Backoff
                const response = await fetchWithBackoff(apiUrl, options);
                const result = await response.json();

                // 3. Process Result
                const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;

                if (!base64Data) {
                    throw new Error("No image data received from the API.");
                }

                const imageUrl = `data:image/png;base64,${base64Data}`;
                
                // 4. Update UI with Image
                generatedImage.src = imageUrl;
                generatedImage.onload = () => {
                    setUIState('ready', 'Image successfully generated!');
                };
                generatedImage.onerror = () => {
                    setUIState('error', 'Failed to load generated image data.');
                };

            } catch (error) {
                // 5. Handle Errors
                console.error("Generation Error:", error);
                const errorMessage = error.message.includes("400") 
                    ? "API request failed. Check your prompt or model availability."
                    : `An unexpected error occurred: ${error.message}`;
                setUIState('error', errorMessage);
            }
        }

        // Initial setup for the dropdown change
        document.addEventListener('DOMContentLoaded', () => {
            aspectRatioSelect.addEventListener('change', () => {
                updateAspectRatioClass(aspectRatioSelect.value);
            });
            // Set initial aspect ratio class on load
            updateAspectRatioClass(aspectRatioSelect.value);
        });

    </script>
</body>
</html>